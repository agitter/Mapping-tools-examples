---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(sf)
library(raster)
```

```{r}
sh_file <- st_read('~/Downloads/al112017_5day_020/al112017-020_5day_lin.shp')
```

```{r}
st_crs(sh_file)
```
```{r}
plot (sh_file, col = "black", lwd=3, main="Title")
```
```{r}

# below code is adapted from http://r-spatial.org/r/2017/08/28/nest.html
library (tidyverse)
```
```{r}
data(storms)
storms
```
```{r}
library (sf)
```

```{r}
storms.sf <- storms %>% st_as_sf(coords = c("long","lat"), crs=4326)
class (storms.sf)
```

```{r}
storms.sf %>% select(name, year, geometry)
```
```{r}
storms.sf <- storms.sf %>% mutate(time = as.POSIXct(paste(paste(year,month,day, sep = "-"), paste(hour, ":00", sep = "")))) %>% select(-month, -day, -hour)
storms.sf %>% select(name, time, geometry)
```

```{r}
cls <- storms.sf %>% pull(status)
cls <- factor (cls, levels = unique(cls))
col = sf.colors(length(levels(cls)))
plot(st_geometry(storms.sf), cex=.2, axes=TRUE,graticule=TRUE,col=col[cls])
legend("topleft",legend=levels(cls),col=col, pch=1)
```

```{r}
(storms.nest <- storms.sf %>% group_by(name, year) %>% nest)
```
```{r}
to_line <- function(tr) st_cast(st_combine(tr), "LINESTRING") %>% .[[1]]
```

```{r}
(tracks <- storms.nest %>% pull(data) %>% map(to_line) %>% st_sfc(crs = 4326))
```

```{r}
(storms.tr <- storms.nest %>% select(-data) %>% st_sf(geometry = tracks))
```

```{r}
# library(ggplot2)
# storms.tr %>% ggplot(aes(color = Name)) + geom_sf() + theme(legend.position = "none")
```

```{r}
library (mapview)
library (leaflet)

storms.tr.2k5 <- subset(storms.tr, year == 2005)

df <- read.csv(textConnection(
"Name,Lat,Long
Miami,25.7548272,-80.4012616
New Orleans,29.9827865,-90.1418686
Houston,29.7644776,-95.4573496
"))

m <- leaflet() %>% addMarkers(lat=df$Lat, lng=df$Long, label=df$Name)

m <- addProviderTiles(m, providers$OpenTopoMap) %>% setView(-90.141, 29.9827, zoom = 4) %>% addTiles ('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', options = tileOptions(opacity = 0.6))
m <- m %>% addPolylines(data = storms.tr.2k5)
m 

mapview(storms.tr.2k5, zcol = "name", legend = TRUE)

```

```{r}
to_lines <- function(tr) { 
    g = st_geometry(tr)
    hd = head(g, -1)
    tl = tail(g, -1)
    map2(hd, tl, function(x,y) st_combine(st_sfc(x, y, crs = 4326))) %>% 
        map(function(x) st_cast(x, "LINESTRING"))
}
```

```{r}
trs <- storms.nest %>% 
    pull(data) %>% 
    map(to_lines) %>% 
    unlist(recursive = FALSE) %>% 
    do.call(c, .)
```

```{r}
fn = function(x) head(x, -1) %>% as.data.frame %>% select(-geometry)
storms.nest <- storms.nest %>% mutate(data = map(data, fn))
```

```{r}
storms.tr2 <- storms.nest %>% unnest %>% st_set_geometry(trs)
nrow(storms.tr2)

# storms.tr2 %>% ggplot(aes(color = wind)) + geom_sf()

mapview(storms.tr2, zcol = "wind", legend = TRUE)

```

```{r}
storms.tr3 <- storms.tr2 %>% 
    filter((time >= as.POSIXct("2005-01-01")) & (time <= as.POSIXct("2005-12-31"))) 
mapview(storms.tr3, zcol = "wind", lwd = 4)
```

Code below adapted from https://lukemiller.org/index.php/2014/11/extracting-noaa-sea-surface-temperatures-with-ncdf4/
```{r}
source("~/Dropbox/Programming/R/NOAA_OISST_ncdf4.R")
ssts = extractOISSTdaily("~/Downloads/sst.day.mean.2005.v2.nc","~/Downloads/lsmask.oisst.v2.nc",lonW=250,lonE=325,latS=10,latN=33,date1='2005-08-01',date2='2005-09-30')
```

```{r}
plotOISST(ssts,1)
plotOISST(ssts,32)
plotOISST(ssts,61)

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

